{{- $iiif := newScratch -}}
{{- $contextPath := path.Dir .File.Path -}}

{{- range .Params.resources -}}
    {{- if .params.featured -}}
        {{- $imgLocation := path.Join $contextPath .src -}}
        {{- if .name -}}
            {{- $iiif.Set "previewImg" ($.Resources.GetMatch .name) -}}
        {{ else }}
            {{- $iiif.Set "previewImg" ($.Resources.GetMatch .src) -}}
        {{- end -}}

        {{- if eq ($iiif.Get "previewImg") nil -}}
            {{- warnf "Can't find image %s" $imgLocation -}}
        {{- end -}}

        {{- $iiif.Set "post" $.File.ContentBaseName -}}
        {{- $iiif.Set "imgLocation" $imgLocation -}}
        {{- $iiif.Set "manifest" .params.iiif -}}
        {{- $iiif.Set "baseURL" (printf "/%s/%s/" $contextPath (path.Dir .params.iiif)) -}}
        {{ if .params.animation }}
            {{- $iiif.Set "animation" .params.animation -}}
        {{ end }}
        {{ if .params.rotate }}
            {{- $iiif.Set "rotate" .params.rotate -}}
        {{ end }}
        {{ if .params.initialZoom }}
            {{- $iiif.Set "initialZoom" .params.initialZoom -}}
        {{ end }}
        {{- $iiif.Set "id" (replace (replace (replace ($iiif.Get "baseURL") "/" "") "." "") "-" "_") -}}

    {{ end }}
{{ end }}


{{- $infoJson := printf "/%s" (path.Join $contextPath ($iiif.Get "manifest")) -}}
{{- $animation := "''" -}}
{{- $initialZoom := 0 -}}
{{ $rotation := 0 }}
{{ if ne ($iiif.Get "animation") nil }}
    {{ $animation = $iiif.Get "animation" }}
{{ end }}
{{ if ne ($iiif.Get "rotate") nil }}
    {{ $rotation = ($iiif.Get "rotate") }}
{{ end }}
{{ if ne ($iiif.Get "initialZoom") nil }}
    {{ $initialZoom = ($iiif.Get "initialZoom") }}
{{ end }}

<div class="iiif-preview">
    <div id="{{ $iiif.Get "id" }}" class="previewer"></div>

    <script type="text/javascript">
        var animation = {{ $animation | safeJS }};
        {{ ($iiif.Get "id") | safeJS }}_Div = document.getElementById("{{ $iiif.Get "id" }}");
        var {{ ($iiif.Get "id") | safeJS }} = animatedMap({{ ($iiif.Get "id") | safeJS }}_Div, "{{ $infoJson }}", {{ $rotation }}, {{ $iiif.Get "baseURL" }}, {{ $initialZoom }}, animation);

/*
        if (animation !== undefined && animation !== '') {
            {{ ($iiif.Get "id") | safeJS }}.once('rendercomplete', function() {
                console.log('Starting animation');
                {{ ($iiif.Get "id") | safeJS }}.getView().animate(animation);
            });
        }
*/
        /* {{ ($iiif.Get "id") | safeJS }}.updateSize(); */
    </script>
  </div>
